<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<style>
			video {
				width: 150px;
				height: 100px;
			}
			input {
				width: 250px;
			}
		</style>
	</head>
	<body>
		<table>
			<tr><td>local</td><td>remote</td></tr>
			<tr>
				<td><video id="local" autoplay></video></td>
				<td><video id="remote" autoplay></video></td>
			</tr>
		</table>
		<script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-firestore.js"></script>
		<script>
			const localVideo = document.getElementById('local');
			localVideo.volume=0;
			const firebaseConfig = {
				apiKey: "AIzaSyBS3nBABn83iamXFdrBlNVzoCgwdCv6j64",
				authDomain: "fir-rtc-323e6.firebaseapp.com",
				projectId: "fir-rtc-323e6",
				storageBucket: "fir-rtc-323e6.appspot.com",
				messagingSenderId: "823603206909",
				appId: "1:823603206909:web:fcbead8a90bf8eb0bbbc94",
				measurementId: "G-ZQ1PTL34NN"
			};
			firebase.initializeApp(firebaseConfig);
			var db=firebase.firestore();
			var stream;
			navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(function(stream_){
				stream=stream_;
				localVideo.srcObject = stream;
				const peerConnection = new RTCPeerConnection({ iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] });
				stream.getTracks().forEach(t => peerConnection.addTrack(t, stream));
				
				const iceCandidates = [];
				peerConnection.onicecandidate = e => {
					if (e.candidate) {
						iceCandidates.push(e.candidate);
					}
				};
				
				peerConnection.ontrack = e => { 
					document.getElementById('remote').srcObject = e.streams[0];
				};
				
				var id=prompt("ID");
				db.collection("calls").doc(id).get().then(async function(data){
					data=data.data();
					var offer=data.offer;
					var iceCandidates=data.iceCandidates;
					
					peerConnection.onicegatheringstatechange = () => {
						if (peerConnection.iceGatheringState === 'complete') {
							db.collection("calls").doc(id).update("answer",{
								answer:JSON.parse(JSON.stringify(answer)),
								iceCandidates:JSON.parse(JSON.stringify(iceCandidates))
							});
							console.log('Answer ready, click copy button.');
						}
					};
					
					await peerConnection.setRemoteDescription(offer);
					const answer = await peerConnection.createAnswer();
					await peerConnection.setLocalDescription(answer);

					iceCandidates.forEach(c => peerConnection.addIceCandidate(c));
				});
			});
		</script>
	</body>
</html>

